<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAMARA - CAPRESSO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- <script type="text/javascript" src="js/instascan.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!--<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="text/javascript" src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
    <!--
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"
        integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous">
    </script>-->
</head>
<body>
    <div class="content" id="detallescanner">
        <center>
            <img src="https://sistemageneral.azurewebsites.net/assets/dist/img/logo.png" alt="CAPRESSO">
            <br><br>
            <h5 id="alertaCargado">Se esta enviado la solicitud...</h5>
            <!--
            <select class="form-select" aria-label="Seleccione una camara" id="selectCamaras">
                <option value="">Seleccione una opción</option>
              </select>
              -->
              <video id="webcam" autoplay></video>
              <canvas id="canvas" style="display: none;"></canvas>
            <br>
            <br>
            <button class="btn btn-primary" onclick="encenderCamara()"><span><i class="bi bi-camera-fill" style="color:white"></i></span></button>
            <button class="btn btn-secondary" onclick="apagarCamara()"><span><i class="bi bi-stop-circle-fill" style="color:white"></i></span></button>
            <a href="." class="btn btn-success"><span><i class="bi bi-arrow-repeat" style="color:white"></i></span></a>
        </center>
        <br>
    </div>
    <div>
      <center>Version 1.0</center> 
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    
</body>
</html>


<script>
  var camaraSelected = 0;
  var encontrado = false;
  var camaras = [];
  var tamCamaras = 0;
  const video = document.getElementById("webcam");
  const canvas = document.getElementById("canvas");
  const context = canvas.getContext("2d");

  navigator.mediaDevices.enumerateDevices()
  .then(devices => {
    const videoDevices = devices.filter(device => device.kind === 'videoinput');
    $.each(videoDevices, function(index, camara) {
      camaras.push(camara.deviceId);
      tamCamaras = tamCamaras+1;
    });
  })
  .catch(error => {
    console.error('Error al obtener los dispositivos: ', error);
  });


  function apagarCamara(){
    $('#alertaCargado').hide();
    $('#webcam').hide();
    stopCam();
    clearCanvas();
    let nroCamera = camaraSelected;
    let camera1Id = camaras[nroCamera];
    encontrado = true;
    /*
    navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: camera1Id } }})
    .then((stream) => {
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        video.stop();
      };
    })
    .catch((error) => console.error("Error al acceder a la cámara:", error));
    */

  }
  
  
  function encenderCamara(){
    $('#alertaCargado').hide();
    $('#webcam').hide();
    stopCam();
    clearCanvas();
    $('#webcam').show();
    encontrado = false;

    //apagarCamara();
      if(camaraSelected == tamCamaras){
          camaraSelected = 0;
      }
    let nroCamera = camaraSelected;
    camaraSelected = camaraSelected + 1;
      console.log('Func: ',nroCamera);
    let camera1Id = camaras[nroCamera];
    navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: camera1Id } }})
    .then((stream) => {
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        if(encontrado == false){
            video.play();
            scanQRCode();
        }else{
            video.stop();
        }
      };
    })
    .catch((error) => console.error("Error al acceder a la cámara:", error));
  }

  function scanQRCode() {
    console.log('buscando..');
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);

    // Llamar a jsQR para decodificar el código QR
    const code = jsQR(imageData.data, canvas.width, canvas.height);
    if (code) {
        if(code.data){
            console.log("Código QR encontrado:", code.data);
            encontrado = true;
            $('#webcam').hide();
            stopCam();
            clearCanvas();
            $('#alertaCargado').show();
            habilitarAccesoGifCard(code.data);
            //alert(code.data)
        }
      
    }

    // Repetir el escaneo
    if(encontrado == false){
        requestAnimationFrame(scanQRCode);
    }
  }

  function stopCam() {
    const videoElement = document.getElementById('webcam'); // Reemplaza 'videoElement' con el ID de tu elemento de video
    const stream = videoElement.srcObject;
    
    if (stream) {
        const tracks = stream.getTracks();
        tracks.forEach(track => track.stop());
        videoElement.srcObject = null;
    }
  }

    function clearCanvas() {
        const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");
        context.clearRect(0, 0, canvas.width, canvas.height);
    }

    function habilitarAccesoGifCard(token){
        //let url_sg = `<?=URL_SISTEMA_GENERAL?>`;
        //enlace = `http://192.168.1.17/SistemaGeneralB/habilitarAccesoGifCard`;
        enlace = `https://sistemademo.azurewebsites.net/habilitarAccesoGifCard`;
        //enlace = url_sg+`/get_venta_progamada`;
        datos = {};

        const options = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'User-Agent': 'insomnia/2023.5.8',
                Authorization: 'Bearer '+token
                },
            body: JSON.stringify(datos)
        };

        fetch(enlace, options)
        .then(response => response.json())
        .then(data =>{
                if(data.status){
                    Swal.fire({
                          title: 'Nro: '+data.numero+' \n \n Saldo: '+data.saldo+'',
                          icon: 'info',
                          confirmButtonText: 'ok'
                        });
                    $('#alertaCargado').hide();
                }else{
                    if(data.message){
                        Swal.fire({
                          title: data.message,
                          icon: 'error'
                        });
                    }else{
                      Swal.fire({
                          title: 'Ocurrio un error.',
                          icon: 'error'
                        });
                    }
                    return;
                }
            }
        ).catch(err => console.error(err));
    }

    $(document).ready(function(){
      $('#alertaCargado').hide();
      encenderCamara();
      let navegador = navigator.userAgent;
      if (window.innerWidth <= 768) {
          //alert("Es un móvil");
          $('#webcam').css('width', '75%');
      }else{
          $('#webcam').css('width', '30%');
          //alert("es una pc");
          $('#miDiv').css('width', '500px');
          $('#miDiv').css('height', '500px');
          $('#miDiv').css('margin', '0px auto');
      }
                                
    });
</script>
